<%- include('./partials/Header.ejs', {hidden: true}) %>

  <main style="padding: var(--spacing-xl) 0; background-color: var(--color-bg-secondary); min-height: 80vh;">
    <div class="container">

      <div style="display: grid; grid-template-columns: 250px 1fr; gap: 2rem;">

        <!-- Sidebar -->
        <aside>
          <%- include('./partials/SellerSidebar.ejs') %>
        </aside>

        <!-- Main Content -->
        <section
          style="background: white; padding: 2.5rem; border-radius: var(--border-radius-lg); box-shadow: var(--shadow-sm);">
          <div
            style="margin-bottom: 2rem; border-bottom: 1px solid var(--color-border); padding-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="font-size: 1.5rem;">My Products</h2>
            <a href="/seller/dashboard" class="btn btn-primary" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
              <i class="ri-add-line"></i> Add New
            </a>
          </div>

          <% if(products && products.length> 0) { %>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.5rem;">
              <% products.forEach((fit)=> { %>
                <div class="product-card-admin"
                  style="border: 1px solid var(--color-border); border-radius: var(--border-radius-md); overflow: hidden; position: relative;">
                  <div style="height: 200px; overflow: hidden; background: #f9f9f9;">
                    <img src="<%= fit.mainImage %>" alt="<%= fit.title %>"
                      style="width: 100%; height: 100%; object-fit: cover;">
                  </div>
                  <div style="padding: 1rem;">
                    <h3
                      style="font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;">
                      <%= fit.title %>
                    </h3>
                    <div
                      style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                      <span style="font-size: 0.9rem; font-weight: 500;">PKR <%= fit.price %></span>
                      <span style="font-size: 0.8rem; color: var(--color-text-secondary);">
                        <%= fit.salesCount || 0 %> Sold
                      </span>
                    </div>

                    <div style="display: flex; gap: 0.5rem;">
                      <button data-id="<%= fit._id %>"
                        class="btn btn-outline prod-feature <%= fit.tags && fit.tags.includes('featured') ? 'active' : '' %>"
                        style="flex: 1; padding: 0.4rem; font-size: 0.8rem; border-color: #FFD700; color: <%= fit.tags && fit.tags.includes('featured') ? 'white' : '#DAA520' %>; background: <%= fit.tags && fit.tags.includes('featured') ? '#FFD700' : 'transparent' %>;">
                        <i
                          class="<%= fit.tags && fit.tags.includes('featured') ? 'ri-star-fill' : 'ri-star-line' %>"></i>
                        <%= fit.tags && fit.tags.includes('featured') ? 'Pinned' : 'Pin' %>
                      </button>
                      <a href="/seller/edit/<%= fit._id %>" class="btn btn-outline"
                        style="flex: 1; padding: 0.4rem; font-size: 0.8rem; text-align: center;">Edit</a>
                      <button data-id="<%= fit._id %>" class="btn btn-primary prod-delete"
                        style="flex: 1; padding: 0.4rem; font-size: 0.8rem;">Delete</button>
                    </div>
                  </div>

                  <% if(!fit.isApproved) { %>
                    <div
                      style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem;">
                      Pending Approval</div>
                    <% } %>
                </div>
                <% }) %>
            </div>
            <% } else { %>
              <div style="text-align: center; padding: 3rem; color: var(--color-text-secondary);">
                <i class="ri-inbox-2-line" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                <p>No products found. Start by adding one!</p>
              </div>
              <% } %>

        </section>

      </div>
    </div>
  </main>

  <!-- Delete Modal -->
  <div id="confirmModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div
      style="background: white; padding: 2rem; border-radius: var(--border-radius-md); width: 90%; max-width: 400px; box-shadow: var(--shadow-lg);">
      <h3 style="margin-bottom: 1rem; font-size: 1.2rem;">Delete Product?</h3>
      <p style="color: var(--color-text-secondary); margin-bottom: 1.5rem;">Are you sure you want to delete this
        product? This action cannot be undone.</p>
      <div style="display: flex; justify-content: flex-end; gap: 1rem;">
        <button id="cancelDelete" class="btn btn-outline" style="padding: 0.5rem 1rem;">Cancel</button>
        <button id="confirmDelete" class="btn btn-primary"
          style="padding: 0.5rem 1rem;">Yes, Delete</button>
      </div>
    </div>
  </div>

  <%- include('./partials/Footer.ejs') %>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
      
        // ===== DELETE PRODUCT =====
        const deleteButtons = document.querySelectorAll('.prod-delete');
        const modal = document.getElementById('confirmModal');
        const cancelBtn = document.getElementById('cancelDelete');
        const confirmBtn = document.getElementById('confirmDelete');
        let pendingDelete = { id: null, card: null };
      
        deleteButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            const card = btn.closest('.product-card-admin');
            pendingDelete = { id, card };
            modal.style.display = 'flex';
          });
        });
      
        cancelBtn.addEventListener('click', () => {
          modal.style.display = 'none';
          pendingDelete = { id: null, card: null };
        });
      
        confirmBtn.addEventListener('click', async () => {
          if (!pendingDelete.id) return;
      
          try {
            const res = await fetch(`/seller/products/${pendingDelete.id}`, {
              method: 'DELETE'
            });
      
            if (!res.ok) throw new Error('Delete failed');
      
            if (pendingDelete.card) pendingDelete.card.remove();
          } catch (err) {
            alert('Error deleting product');
          } finally {
            modal.style.display = 'none';
            pendingDelete = { id: null, card: null };
          }
        });
      
      
        // ===== FEATURE / PIN PRODUCT =====
        const featureButtons = document.querySelectorAll('.prod-feature');
      
        featureButtons.forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = btn.dataset.id;
      
            try {
              const res = await fetch(`/seller/feature/${id}`, {
                method: 'POST'
              });
      
              const data = await res.json();
      
              if (data.success) {
                if (data.isFeatured) {
                  btn.style.background = '#FFD700';
                  btn.style.color = 'white';
                  btn.innerHTML = '<i class="ri-star-fill"></i> Pinned';
                } else {
                  btn.style.background = 'transparent';
                  btn.style.color = '#DAA520';
                  btn.innerHTML = '<i class="ri-star-line"></i> Pin';
                }
              }
            } catch (err) {
              console.error(err);
              alert('Error updating status');
            }
          });
        });
      
      });
    </script>
      

    <style>
      @media(max-width: 768px) {
        .container>div {
          grid-template-columns: 1fr !important;
        }
      }
    </style>