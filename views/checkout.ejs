<%- include('./partials/Header.ejs', {hidden: true}) %>

  <main style="padding: var(--spacing-xl) 0; min-height: 80vh; background-color: var(--color-bg-primary);">
    <div class="container" style="max-width: 900px;">

      <div
        style="background: white; padding: 2.5rem; border-radius: var(--border-radius-lg); box-shadow: var(--shadow-sm);">
        <h2
          style="font-size: 1.8rem; margin-bottom: 2rem; border-bottom: 1px solid var(--color-border); padding-bottom: 1rem;">
          Checkout</h2>

        <form action="/checkout" method="POST"
          style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 3rem; align-items: start;">

          <!-- Shipping & Personal Details -->
          <div class="checkout-form">
            <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1.5rem;">Shipping Information</h3>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">First Name</label>
                <input type="text" name="fullName" required
                  style="width: 100%; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: 4px;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Last Name</label>
                <input type="text" name="lastName" required
                  style="width: 100%; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: 4px;">
                <!-- Note: Backend usually expects 'fullName', but checkout.ejs had split fields. Using lastName just in case, but concatenating client side or server side might be needed if schema strictly wants 'fullName' only. 
                            However, cart.ejs used 'fullName'. checkout.ejs used 'fullName' AND 'lastName'? 
                            Checking checkout.ejs again: it had name="fullName" for First Name and name="lastName" for Last Name. 
                            Let's keep both to be safe, but typically schemas are 'fullName'. 
                            Actually, viewing checkout.ejs again, line 16 name="fullName", line 20 name="lastName". 
                            -->
              </div>
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Email Address</label>
              <input type="email" name="email" required
                style="width: 100%; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: 4px;">
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Phone Number</label>
              <input type="number" name="phoneNumber" required
                style="width: 100%; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: 4px;">
            </div>

            <div style="margin-bottom: 1rem;">
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Address</label>
              <input type="text" name="street" placeholder="Street Address" required
                style="width: 100%; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: 4px;">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">City</label>
                <input type="text" name="city" required
                  style="width: 100%; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: 4px;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">State</label>
                <input type="text" name="state" required
                  style="width: 100%; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: 4px;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ZIP Code</label>
                <input type="text" name="zip" required
                  style="width: 100%; padding: 0.8rem; border: 1px solid var(--color-border); border-radius: 4px;">
              </div>
            </div>

            <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">Payment Method</h3>
            <div style="background: #f9f9f9; padding: 1rem; border-radius: 4px; border: 1px solid var(--color-border);">
              <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" checked disabled style="width: 1.2rem; height: 1.2rem; margin-right: 0.8rem;">
                <span style="font-weight: 500;">Cash on Delivery (COD)</span>
              </label>
              <!-- <p>Amount (PKR):</p>

              <input type="number" id="amount" value="1500" />

              <br><br>

            <button id="payBtn">Pay with JazzCash (Sandbox)</button> -->
            </div>

          </div>

          <!-- Order Summary Side Panel -->
          <div
            style="background: #f9f9f9; padding: 1.5rem; border-radius: var(--border-radius-md); border: 1px solid var(--color-border);">
            <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1.5rem;">Order Summary</h3>

            <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
              <div
                style="width: 60px; height: 60px; background: white; border-radius: 4px; overflow: hidden; border: 1px solid var(--color-border);">
                <!-- Assuming 'product' is passed from route -->
                <img src="<%= product.mainImage || product.image %>"
                  style="width: 100%; height: 100%; object-fit: contain;">
              </div>
              <div style="flex: 1;">
                <h4 style="font-size: 0.95rem; font-weight: 500; line-height: 1.3;">
                  <%= product.title %>
                </h4>
              </div>
            </div>

            <ul
              style="display: flex; flex-direction: column; gap: 0.8rem; margin-bottom: 1.5rem; border-top: 1px dashed var(--color-border); padding-top: 1rem;">
              <li style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                <span>Subtotal</span>
                <span>PKR <%= product.price %></span>
              </li>

              <% if (product.discountInfo && product.discountInfo.percent> 0) { %>
                <li
                  style="display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--color-accent-primary);">
                  <span>Discount (<%= product.discountInfo.percent %>%)</span>
                  <span>- PKR <%= (product.price - product.discountInfo.finalPrice).toFixed(0) %></span>
                </li>
                <% } %>

                  <li style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                    <span>Shipping</span>
                    <span>PKR 250.00</span>
                  </li>

                  <li
                    style="display: flex; justify-content: space-between; font-size: 1.1rem; font-weight: 700; border-top: 1px solid var(--color-border); padding-top: 1rem; margin-top: 0.5rem;">
                    <span>Total</span>
                    <span>
                      <% if (product.discountInfo && product.discountInfo.percent> 0) { %>
                        PKR <%= (product.discountInfo.finalPrice + 250).toFixed(2) %>
                          <% } else { %>
                            PKR <%= (product.price + 250).toFixed(2) %>
                              <% } %>
                    </span>
                  </li>
            </ul>

            <!-- Hidden Inputs -->
            <input required name="single" value="true" type="hidden">
            <input required name="productId" value="<%=product._id%>" type="hidden">
            <input required name="totalPrice"
              value="<%= product.discountInfo && product.discountInfo.percent > 0 ? product.discountInfo.finalPrice : product.price %>"
              type="hidden">

            <button type="submit" class="btn btn-primary" style="width: 100%; padding: 1rem;">
              Place Order
            </button>
            <p style="text-align: center; font-size: 0.8rem; color: var(--color-text-secondary); margin-top: 1rem;">
              Secure Checkout
            </p>
          </div>

        </form>
      </div>

    </div>
  </main>

  <style>
    @media(max-width: 900px) {
      form {
        grid-template-columns: 1fr !important;
        gap: 2rem !important;
      }

      .checkout-form {
        order: 2;
      }

      form>div:nth-child(2) {
        order: 1;
        /* Summary on top for mobile often better, or bottom. Let's keep natural order if stacked, actually bottom usually better for inputs first. */
        order: 2;
      }

      .checkout-form {
        order: 1;
      }
    }
  </style>
  <script>
    document.getElementById("payBtn").addEventListener("click", async () => {
      const payBtn = document.getElementById("payBtn");
      const amount = document.getElementById("amount").value;

      payBtn.disabled = true;
      payBtn.innerText = "Redirecting...";

      try {
        const res = await fetch("http://localhost:3000/api/payment/pay", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ amount })
        });

        const payload = await res.json();

        // Create form for JazzCash
        const form = document.createElement("form");
        form.method = "POST";
        form.action = payload.paymentURL;

        // Add hidden fields
        Object.entries(payload.data).forEach(([key, value]) => {
          const input = document.createElement("input");
          input.type = "hidden";
          input.name = key;
          input.value = value;
          form.appendChild(input);
        });

        document.body.appendChild(form);
        form.submit();

      } catch (err) {
        console.error(err);
        alert("Failed to start payment");
        payBtn.disabled = false;
        payBtn.innerText = "Pay with JazzCash (Sandbox)";
      }
    });
  </script>

  <%- include('./partials/Footer.ejs') %>